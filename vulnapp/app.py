import os
import subprocess as sp
from flask import Flask, render_template, request, send_file, abort
from werkzeug.utils import secure_filename

app = Flask(__name__)
base = os.path.dirname(__name__)
uploads = os.path.join(base,'uploads')
output = os.path.join(base,'output')

def run_ps2pdf(input_file,output_file):
	try:
		sp.run(['ps2pdf',input_file,output_file],check=True)
	except sp.CalledProcessError as cpe:
		raise cpe

@app.route("/")
def index():
	return render_template('index.html')

@app.route("/upload",methods=['POST'])
def upload():
	file = request.files['psfile']
	secure_name = secure_filename(file.filename)
	secure_name_converted = secure_name.split('.')[0] + '.pdf'
	input_file = os.path.join(uploads,secure_name)
	output_file = os.path.join(output,secure_name_converted)
	try:
		file.save(input_file)
		run_ps2pdf(input_file,output_file)
		return send_file(output_file, as_attachment=True, download_name=secure_name_converted)
	except Exception as e:
		abort(500,str(e))
